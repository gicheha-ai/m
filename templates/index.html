<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EUR/USD 2-Minute Auto-Learning Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-dark: #0a1929;
            --secondary-dark: #132f4c;
            --accent-blue: #007bff;
            --accent-green: #00d4aa;
            --accent-red: #ff4757;
            --accent-yellow: #ffd700;
        }
        
        body {
            background-color: var(--primary-dark);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .trading-card {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, #1a3a5f 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .trading-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem 1.5rem;
        }
        
        .buy-signal {
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
        }
        
        .sell-signal {
            color: var(--accent-red);
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
        }
        
        .wait-signal {
            color: var(--accent-yellow);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .progress {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .table-dark {
            background-color: rgba(19, 47, 76, 0.8);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-dark th {
            background-color: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid var(--accent-blue);
            font-weight: 600;
            padding: 1rem;
        }
        
        .table-dark td {
            padding: 0.75rem 1rem;
            border-color: rgba(255, 255, 255, 0.05);
        }
        
        .table-dark tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .badge {
            padding: 0.35em 0.65em;
            font-weight: 500;
            border-radius: 6px;
        }
        
        .display-6 {
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .bg-success {
            background-color: var(--accent-green) !important;
        }
        
        .bg-danger {
            background-color: var(--accent-red) !important;
        }
        
        .bg-warning {
            background-color: var(--accent-yellow) !important;
            color: #000;
        }
        
        .bg-info {
            background-color: var(--accent-blue) !important;
        }
        
        .border-warning {
            border-color: var(--accent-yellow) !important;
        }
        
        .border-primary {
            border-color: var(--accent-blue) !important;
        }
        
        .border-success {
            border-color: var(--accent-green) !important;
        }
        
        .border-danger {
            border-color: var(--accent-red) !important;
        }
        
        .text-success {
            color: var(--accent-green) !important;
        }
        
        .text-danger {
            color: var(--accent-red) !important;
        }
        
        .text-warning {
            color: var(--accent-yellow) !important;
        }
        
        .text-info {
            color: var(--accent-blue) !important;
        }
        
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent-green);
        }
        
        .toast-container {
            z-index: 9999;
        }
        
        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        @media (max-width: 768px) {
            .display-6 {
                font-size: 2rem;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="bg-dark">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card trading-card border-warning">
                    <div class="card-body text-center">
                        <h1 class="text-warning mb-2"><i class="bi bi-graph-up-arrow"></i> EUR/USD 2-Minute Auto-Learning Trading System</h1>
                        <p class="text-light mb-0">
                            <i class="bi bi-clock"></i> Predictions every 120 seconds • 
                            <i class="bi bi-cpu"></i> ML-Optimized TP/SL • 
                            <i class="bi bi-git"></i> Git Auto-Sync Storage •
                            <i class="bi bi-cash-coin"></i> Real-time Virtual Trading
                        </p>
                        <div class="mt-2">
                            <span id="systemStatus" class="badge bg-success">System Active</span>
                            <span id="cycleDuration" class="badge bg-primary">120s Cycle</span>
                            <span id="gitRepoStatus" class="badge bg-success"><i class="bi bi-git"></i> Git Auto-Sync</span>
                            <span id="mlFooterStatus" class="badge bg-warning">ML Learning</span>
                        </div>
                        <div class="mt-2" id="gitSyncInfo">
                            <div class="small text-muted">
                                <i class="bi bi-arrow-repeat"></i> Initializing Git Sync...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Row: System Status -->
        <div class="row mb-4">
            <!-- Cycle Status -->
            <div class="col-md-3">
                <div class="card trading-card h-100 border-primary">
                    <div class="card-header bg-primary">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Trading Cycle</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Cycle Count:</span>
                            <span class="fs-5 fw-bold text-info" id="cycleCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Next Cycle In:</span>
                            <span class="fs-5 fw-bold text-warning" id="nextCycle">120s</span>
                        </div>
                        <div class="mb-3">
                            <div class="progress" style="height: 15px;">
                                <div id="cycleProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                     role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <small class="text-muted mt-1 d-block text-center">Cycle Progress (120 seconds)</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Remaining Time:</span>
                            <span id="remainingTime" class="fw-bold">120s</span>
                        </div>
                        <hr class="my-3">
                        <div class="d-flex justify-content-between">
                            <span>Last Update:</span>
                            <span id="lastUpdate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Price -->
            <div class="col-md-3">
                <div class="card trading-card h-100 border-success">
                    <div class="card-header bg-success">
                        <h5 class="mb-0"><i class="bi bi-currency-exchange"></i> Market Data</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span class="text-muted d-block mb-1">EUR/USD Price</span>
                            <span class="display-6 fw-bold text-light" id="currentPrice">1.08500</span>
                        </div>
                        <div class="row text-start">
                            <div class="col-6">Data Source:</div>
                            <div class="col-6 text-end text-info" id="dataSource">-</div>
                        </div>
                        <div class="row text-start mt-2">
                            <div class="col-6">API Status:</div>
                            <div class="col-6 text-end">
                                <span id="apiStatus" class="badge bg-success">CONNECTED</span>
                            </div>
                        </div>
                        <div class="row text-start mt-2">
                            <div class="col-6">Data Storage:</div>
                            <div class="col-6 text-end">
                                <span id="dataStorage" class="badge bg-info">
                                    <i class="bi bi-git"></i> Git Auto-Sync
                                </span>
                            </div>
                        </div>
                        <div class="row text-start mt-2">
                            <div class="col-6">Server Time:</div>
                            <div class="col-6 text-end text-light" id="serverTime">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prediction -->
            <div class="col-md-3">
                <div class="card trading-card h-100 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> 2-Minute Prediction</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-4">
                            <span class="text-muted d-block mb-1">Direction</span>
                            <span id="prediction" class="display-6 fw-bold">ANALYZING</span>
                        </div>
                        <div class="mb-4">
                            <span class="text-muted d-block mb-1">Confidence</span>
                            <div class="progress" style="height: 20px;">
                                <div id="confidenceBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <span id="confidenceText" class="mt-1 d-block fw-bold">0%</span>
                        </div>
                        <div class="mb-3">
                            <span class="text-muted d-block mb-1">Signal Strength</span>
                            <span id="signalStrength" class="badge bg-warning fs-5 px-3">0/3</span>
                        </div>
                        <div>
                            <span class="text-muted d-block mb-1">Action</span>
                            <span id="action" class="badge bg-secondary fs-5 p-2 px-4">WAIT</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="col-md-3">
                <div class="card trading-card h-100 border-info">
                    <div class="card-header bg-info">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Trading Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6">Balance:</div>
                            <div class="col-6 text-end fw-bold text-success" id="balance">$10,000.00</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Total Trades:</div>
                            <div class="col-6 text-end fw-bold" id="totalTrades">0</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Win Rate:</div>
                            <div class="col-6 text-end fw-bold text-success" id="winRate">0%</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Trade Status:</div>
                            <div class="col-6 text-end">
                                <span id="tradeStatus" class="badge bg-secondary">NO_TRADE</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">ML Ready:</div>
                            <div class="col-6 text-end">
                                <span id="mlReady" class="badge bg-success">Yes</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Trade Progress:</div>
                            <div class="col-6 text-end fw-bold" id="tradeProgress">0%</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Cache Efficiency:</div>
                            <div class="col-6 text-end">
                                <span id="cacheEfficiency" class="badge bg-info">0%</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">ML Samples:</div>
                            <div class="col-6 text-end">
                                <span id="mlSamplesCount" class="badge bg-dark">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Row: Chart and Trade Info -->
        <div class="row mb-4">
            <!-- Main Chart -->
            <div class="col-md-8">
                <div class="card trading-card h-100 border-dark">
                    <div class="card-header bg-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Live Trading Chart (2-Minute View)</h5>
                            <div>
                                <span class="badge bg-warning me-2" id="chartStatus">Live Chart</span>
                                <button id="toggleChart" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-arrows-angle-expand"></i> Fullscreen
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="chart" style="height: 450px; width: 100%;"></div>
                    </div>
                </div>
            </div>

            <!-- Active Trade & TP/SL -->
            <div class="col-md-4">
                <!-- Active Trade -->
                <div class="card trading-card mb-3 border-danger">
                    <div class="card-header bg-danger">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> Active Trade</h5>
                    </div>
                    <div class="card-body" id="activeTrade">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split display-4 d-block mb-3"></i>
                            <span class="fs-5">No active trade</span>
                            <p class="small mt-2">Waiting for next trading signal...</p>
                        </div>
                    </div>
                </div>

                <!-- Git Storage Info with ML Status -->
                <div class="card trading-card mb-3 border-dark">
                    <div class="card-header bg-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-git"></i> Git Auto-Sync Storage</h5>
                            <div id="mlStatusContainer">
                                <span class="badge bg-warning">ML Learning</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body text-center" id="storageInfo">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-database display-6 d-block mb-2 text-info"></i>
                            <span>Loading storage info...</span>
                            <p class="small mt-2">Auto-sync • Survives redeploys • ML Auto-learn</p>
                        </div>
                    </div>
                </div>

                <!-- TP/SL Levels -->
                <div class="card trading-card border-secondary">
                    <div class="card-header bg-secondary">
                        <h5 class="mb-0"><i class="bi bi-bullseye"></i> TP/SL Levels</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12 text-center mb-3">
                                <div class="d-inline-block p-3 rounded bg-dark">
                                    <small class="text-muted d-block">Risk/Reward</small>
                                    <span id="riskReward" class="fs-4 fw-bold text-info">1:2</span>
                                </div>
                                <div class="d-inline-block p-3 rounded bg-dark ms-2">
                                    <small class="text-muted d-block">Volatility</small>
                                    <span id="volatility" class="fs-4 fw-bold text-warning">MEDIUM</span>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Take Profit:</div>
                            <div class="col-6 text-end fw-bold text-success" id="optimalTp">-</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Stop Loss:</div>
                            <div class="col-6 text-end fw-bold text-danger" id="optimalSl">-</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">TP Distance:</div>
                            <div class="col-6 text-end" id="tpPips">
                                <span class="badge bg-success">0 pips</span>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-6">SL Distance:</div>
                            <div class="col-6 text-end" id="slPips">
                                <span class="badge bg-danger">0 pips</span>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-grid gap-2">
                                    <div class="d-flex gap-2">
                                        <button id="viewStorageBtn" class="btn btn-dark flex-fill">
                                            <i class="bi bi-github"></i> View Repo
                                        </button>
                                        <button id="syncNowBtn" class="btn btn-success flex-fill">
                                            <i class="bi bi-arrow-repeat"></i> Sync Now
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button id="refreshBtn" class="btn btn-info flex-fill">
                                            <i class="bi bi-arrow-repeat"></i> Refresh
                                        </button>
                                        <button id="resetBtn" class="btn btn-warning flex-fill">
                                            <i class="bi bi-arrow-clockwise"></i> Reset
                                        </button>
                                    </div>
                                    <button id="toggleRefresh" class="btn btn-outline-light">
                                        <i class="bi bi-play-circle"></i> Auto-Refresh: 
                                        <span id="autoRefreshStatus" class="badge bg-success">Enabled</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row: Trade History -->
        <div class="row">
            <div class="col-12">
                <div class="card trading-card border-light">
                    <div class="card-header bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Trade History (Git Auto-Sync)</h5>
                            <div>
                                <span class="badge bg-dark me-2">Total: <span id="totalHistoryTrades">0</span></span>
                                <span class="badge bg-success">Wins: <span id="totalWins">0</span></span>
                                <span id="gitRepoLink" class="badge bg-dark ms-2">
                                    <i class="bi bi-git"></i> Auto-Sync
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Time</th>
                                        <th>Action</th>
                                        <th>Entry</th>
                                        <th>TP/SL</th>
                                        <th>Exit</th>
                                        <th>Pips</th>
                                        <th>Duration</th>
                                        <th>Result</th>
                                        <th>Confidence</th>
                                        <th>Signal</th>
                                    </tr>
                                </thead>
                                <tbody id="tradeHistory">
                                    <tr>
                                        <td colspan="11" class="text-center py-4">
                                            <i class="bi bi-inbox display-6 d-block text-muted mb-2"></i>
                                            <span class="text-muted">No trades yet</span>
                                            <div class="small text-info mt-2">
                                                <i class="bi bi-git"></i> All trades auto-saved to Git repository
                                                <br>
                                                <i class="bi bi-cpu"></i> ML will train after 10 trades
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted text-center bg-transparent">
                        <small>
                            Showing last 10 trades • Complete history saved to <code class="text-info">data/trades.json</code> • 
                            120-second cycles • Git Auto-Sync: <code class="text-info">https://github.com/gicheha-ai/m.git</code>
                            • ML Training: Auto-train when sufficient data
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center text-muted">
                    <small>
                        <i class="bi bi-c-circle"></i> 2024 EUR/USD 2-Minute Auto-Learning Trading System • 
                        System: <span id="systemStatusFooter" class="badge bg-success">Active</span> • 
                        Auto-refresh: <span id="autoRefreshToggle" class="badge bg-info">Enabled</span> • 
                        Cycle: <span class="badge bg-primary">120s</span> • 
                        Cache: <span id="cacheInfo" class="badge bg-secondary">0% efficient</span> • 
                        Storage: <span class="badge bg-success"><i class="bi bi-git"></i> Git Auto-Sync</span> • 
                        ML: <span id="mlStatusBadge" class="badge bg-warning">Learning</span> • 
                        Version 2.0-Git-Auto-Sync
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- ALL JAVASCRIPT EMBEDDED HERE - NO EXTERNAL FILES NEEDED -->
    <script>
        // ==================== CONFIGURATION ====================
        const REFRESH_INTERVAL = 2000; // 2 seconds
        const HISTORY_REFRESH_INTERVAL = 5000; // 5 seconds
        const CYCLE_DURATION = 120; // 120 seconds for 2 minutes

        // ==================== STATE ====================
        let refreshTimer = null;
        let historyTimer = null;
        let storageTimer = null;
        let lastUpdateTime = null;
        let isAutoRefreshEnabled = true;
        let chartInstance = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('EUR/USD 2-Minute Trading System with Git Auto-Sync Initialized');
            
            initializeDashboard();
            setupEventListeners();
            
            fetchTradingState();
            fetchTradeHistory();
            fetchStorageStatus();
            fetchMLStatus();
            
            startAutoRefresh();
        });

        // ==================== DASHBOARD INITIALIZATION ====================
        function initializeDashboard() {
            console.log('Dashboard initialized (All-in-One Embedded)');
            
            updateSystemStatus('Connecting...', 'warning');
            updateAutoRefreshStatus(true);
            
            updateElementText('remainingTime', `${CYCLE_DURATION}s`);
            updateElementText('cycleDuration', `${CYCLE_DURATION}s`);
            
            updateElementText('dataStorage', `
                <span class="badge bg-info">
                    <i class="bi bi-git"></i> Git Auto-Sync
                </span>
            `);
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Sync Now button
            document.getElementById('syncNowBtn').addEventListener('click', function() {
                syncWithGit();
            });
            
            // View Git storage button
            document.getElementById('viewStorageBtn').addEventListener('click', function() {
                window.open('https://github.com/gicheha-ai/m/tree/main/data', '_blank');
                showToast('Opening Git repository...', 'info');
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                console.log('Manual refresh triggered');
                fetchTradingState();
                fetchTradeHistory();
                fetchStorageStatus();
                fetchMLStatus();
                showToast('Data refreshed from Git storage', 'info');
            });
            
            // Reset trading button
            document.getElementById('resetBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset all trading statistics? This will clear trade history and reset balance to $10,000.')) {
                    resetTrading();
                }
            });
            
            // Auto-refresh toggle button
            document.getElementById('toggleRefresh').addEventListener('click', function() {
                toggleAutoRefresh();
            });
            
            // Toggle chart fullscreen
            document.getElementById('toggleChart').addEventListener('click', function() {
                toggleChartFullscreen();
            });
            
            // Auto-refresh toggle in footer
            document.getElementById('autoRefreshToggle').addEventListener('click', function() {
                toggleAutoRefresh();
            });
        }

        // ==================== API COMMUNICATION ====================
        function fetchTradingState() {
            console.log('Fetching trading state...');
            
            fetch('/api/trading_state')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Trading state received:', data);
                    updateDashboard(data);
                    updateSystemStatus('Active', 'success');
                    lastUpdateTime = new Date();
                    
                    if (data.git_last_commit || data.git_commit_count) {
                        updateGitSyncInfo(data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching trading state:', error);
                    updateSystemStatus('Connection Error', 'danger');
                    showToast('Failed to fetch trading data', 'error');
                });
        }

        function fetchMLStatus() {
            fetch('/api/ml_status')
                .then(response => response.json())
                .then(data => {
                    console.log('ML status received:', data);
                    updateMLStatusDisplay(data);
                })
                .catch(error => {
                    console.error('Error fetching ML status:', error);
                });
        }

        function fetchTradeHistory() {
            fetch('/api/trade_history')
                .then(response => response.json())
                .then(data => {
                    console.log('Trade history received:', data.trades ? data.trades.length : 0, 'trades');
                    updateTradeHistory(data);
                    
                    if (data.ml_samples !== undefined) {
                        updateElementText('mlSamplesCount', data.ml_samples);
                    }
                })
                .catch(error => {
                    console.error('Error fetching trade history:', error);
                });
        }

        function fetchStorageStatus() {
            fetch('/api/storage_status')
                .then(response => response.json())
                .then(data => {
                    console.log('Storage status received:', data);
                    updateStorageStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching storage status:', error);
                });
        }

        function syncWithGit() {
            fetch('/api/sync_now', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Synced with Git repository!', 'success');
                    fetchTradingState();
                    fetchTradeHistory();
                    fetchStorageStatus();
                    fetchMLStatus();
                } else {
                    showToast('Git sync failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error syncing with Git:', error);
                showToast('Error syncing with Git', 'error');
            });
        }

        function resetTrading() {
            fetch('/api/reset_trading', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Trading statistics reset successfully!', 'success');
                    fetchTradingState();
                    fetchTradeHistory();
                    fetchStorageStatus();
                    fetchMLStatus();
                } else {
                    showToast('Failed to reset trading', 'error');
                }
            })
            .catch(error => {
                console.error('Error resetting trading:', error);
                showToast('Error resetting trading', 'error');
            });
        }

        // ==================== DASHBOARD UPDATES ====================
        function updateDashboard(data) {
            if (!data) return;
            
            console.log('Updating dashboard with live data');
            
            // Update cycle information
            updateElementText('cycleCount', data.cycle_count || 0);
            updateElementText('nextCycle', `${data.next_cycle_in || CYCLE_DURATION}s`);
            updateElementText('remainingTime', `${data.remaining_time || CYCLE_DURATION}s`);
            
            // Update progress bars
            const cycleProgress = data.cycle_progress || 0;
            updateProgressBar('cycleProgress', cycleProgress, 'bg-info');
            
            const tradeProgress = data.trade_progress || 0;
            updateElementText('tradeProgress', `${Math.round(tradeProgress)}%`);
            
            // Update time
            updateElementText('lastUpdate', data.last_update || '-');
            updateElementText('serverTime', formatTime(data.server_time));
            
            // Update market data
            updateElementText('currentPrice', (data.current_price || 1.08500).toFixed(5));
            updateElementText('dataSource', data.data_source || '-');
            
            // Update API status
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = data.api_status || 'UNKNOWN';
            apiStatus.className = `badge ${
                data.api_status === 'CONNECTED' ? 'bg-success' :
                data.api_status === 'CACHED' ? 'bg-warning' :
                data.api_status === 'STALE_CACHE' ? 'bg-warning' :
                data.api_status === 'SIMULATION' ? 'bg-secondary' :
                'bg-danger'
            }`;
            
            // Update data storage status
            const dataStorage = document.getElementById('dataStorage');
            const storageType = data.data_storage || 'GIT_REPO_SYNCING';
            let badgeClass = 'bg-info';
            let icon = 'bi-git';
            let text = 'Git Auto-Sync';
            
            if (storageType.includes('READY')) {
                badgeClass = 'bg-success';
                text = 'Git Auto-Sync Ready';
            } else if (storageType.includes('ERROR')) {
                badgeClass = 'bg-danger';
                text = 'Git Sync Error';
            }
            
            dataStorage.innerHTML = `
                <span class="badge ${badgeClass}">
                    <i class="bi ${icon}"></i>
                    ${text}
                </span>
            `;
            
            // Update signal strength
            const signalStrength = document.getElementById('signalStrength');
            const strength = data.signal_strength || 0;
            signalStrength.textContent = `${strength}/3`;
            signalStrength.className = `badge ${
                strength === 3 ? 'bg-success' :
                strength === 2 ? 'bg-warning' :
                'bg-secondary'
            }`;
            
            // Update prediction
            const prediction = document.getElementById('prediction');
            const pred = data.minute_prediction || 'ANALYZING';
            prediction.textContent = pred;
            prediction.className = `display-6 fw-bold ${
                pred === 'BULLISH' ? 'buy-signal' :
                pred === 'BEARISH' ? 'sell-signal' :
                'wait-signal'
            }`;
            
            // Update confidence
            const confidence = data.confidence || 0;
            updateProgressBar('confidenceBar', confidence, getConfidenceColor(confidence));
            updateElementText('confidenceText', `${confidence.toFixed(1)}%`);
            
            // Update action
            const action = document.getElementById('action');
            const act = data.action || 'WAIT';
            action.textContent = act;
            action.className = `badge ${
                act === 'BUY' ? 'bg-success fs-5 p-2' :
                act === 'SELL' ? 'bg-danger fs-5 p-2' :
                'bg-secondary fs-5 p-2'
            }`;
            
            // Update statistics
            updateElementText('balance', `$${(data.balance || 10000).toFixed(2)}`);
            updateElementText('totalTrades', data.total_trades || 0);
            updateElementText('winRate', `${(data.win_rate || 0).toFixed(1)}%`);
            updateElementText('tradeStatus', data.trade_status || 'NO_TRADE');
            
            // Update ML status
            const mlReady = document.getElementById('mlReady');
            mlReady.textContent = data.ml_model_ready ? 'Yes' : 'No';
            mlReady.className = `badge ${data.ml_model_ready ? 'bg-success' : 'bg-warning'}`;
            
            // Update TP/SL levels
            updateElementText('optimalTp', data.optimal_tp ? data.optimal_tp.toFixed(5) : '-');
            updateElementText('optimalSl', data.optimal_sl ? data.optimal_sl.toFixed(5) : '-');
            
            const tpPips = data.tp_distance_pips || 0;
            const slPips = data.sl_distance_pips || 0;
            updateElementText('tpPips', `<span class="badge bg-success">${tpPips} pips</span>`);
            updateElementText('slPips', `<span class="badge bg-danger">${slPips} pips</span>`);
            
            // Update risk/reward ratio
            if (tpPips > 0 && slPips > 0) {
                const riskReward = (tpPips / slPips).toFixed(2);
                updateElementText('riskReward', `1:${riskReward}`);
            }
            
            // Update cache efficiency
            if (data.cache_efficiency) {
                updateElementText('cacheEfficiency', data.cache_efficiency);
                updateElementText('cacheInfo', data.cache_efficiency);
            }
            
            // Update volatility
            if (data.volatility) {
                updateElementText('volatility', data.volatility);
            }
            
            // Update active trade
            updateActiveTrade(data.current_trade);
            
            // Update Git repo link
            if (data.git_repo_url) {
                updateElementText('gitRepoLink', `
                    <a href="${data.git_repo_url}" target="_blank" class="text-decoration-none text-light">
                        <i class="bi bi-github"></i> View on GitHub
                    </a>
                `);
            }
            
            // Update chart if data available
            if (data.chart_data) {
                updateChart(data.chart_data);
            }
            
            // Update footer status
            updateFooterStatus();
        }

        function updateGitSyncInfo(data) {
            const gitSyncInfo = document.getElementById('gitSyncInfo');
            if (gitSyncInfo && (data.git_last_commit || data.git_commit_count)) {
                const lastCommit = data.git_last_commit || 'Never';
                const commitCount = data.git_commit_count || 0;
                
                gitSyncInfo.innerHTML = `
                    <div class="small text-success">
                        <i class="bi bi-git"></i> Last Commit: ${lastCommit}
                        <br>
                        <i class="bi bi-hash"></i> Total Commits: ${commitCount}
                    </div>
                `;
            }
        }

        function updateMLStatusDisplay(mlData) {
            const mlStatusContainer = document.getElementById('mlStatusContainer');
            if (mlStatusContainer) {
                const isTrained = mlData.ml_model_ready || false;
                const samples = mlData.training_samples || 0;
                const usingML = mlData.using_ml_for_predictions || false;
                
                mlStatusContainer.innerHTML = `
                    <span class="badge ${isTrained ? 'bg-success' : 'bg-warning'}">
                        <i class="bi bi-cpu"></i> ${isTrained ? 'ML Trained' : 'ML Learning'}
                    </span>
                `;
            }
            
            updateElementText('mlSamplesCount', mlData.training_samples || 0);
            
            const mlFooterStatus = document.getElementById('mlFooterStatus');
            const mlStatusBadge = document.getElementById('mlStatusBadge');
            if (mlFooterStatus && mlStatusBadge) {
                const isTrained = mlData.ml_model_ready || false;
                mlFooterStatus.textContent = isTrained ? 'ML Active' : 'ML Learning';
                mlFooterStatus.className = `badge ${isTrained ? 'bg-success' : 'bg-warning'}`;
                mlStatusBadge.textContent = isTrained ? 'Trained' : 'Learning';
                mlStatusBadge.className = `badge ${isTrained ? 'bg-success' : 'bg-warning'}`;
            }
        }

        function updateActiveTrade(trade) {
            const activeTradeDiv = document.getElementById('activeTrade');
            
            if (!trade) {
                activeTradeDiv.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-hourglass-split display-4 d-block mb-3"></i>
                        <span class="fs-5">No active trade</span>
                        <p class="small mt-2">Waiting for next trading signal...</p>
                    </div>
                `;
                return;
            }
            
            const profitPips = trade.profit_pips || 0;
            const duration = trade.duration_seconds || 0;
            const timeRemaining = Math.max(0, CYCLE_DURATION - duration);
            const profitPercent = trade.profit_amount ? ((trade.profit_amount / trade.trade_size) * 100).toFixed(3) : '0.000';
            const mlUsed = trade.ml_used || false;
            
            const progressPercent = Math.min(100, (duration / CYCLE_DURATION) * 100);
            
            activeTradeDiv.innerHTML = `
                <div class="text-center">
                    <h5 class="${trade.action === 'BUY' ? 'text-success' : 'text-danger'}">
                        <i class="bi ${trade.action === 'BUY' ? 'bi-arrow-up-circle' : 'bi-arrow-down-circle'}"></i>
                        ${trade.action} #${trade.id}
                    </h5>
                    
                    ${mlUsed ? `
                    <div class="small text-info mb-2">
                        <i class="bi bi-cpu"></i> ML-Optimized Trade
                    </div>
                    ` : ''}
                    
                    <div class="row text-start mt-3">
                        <div class="col-6"><small>Entry Price:</small></div>
                        <div class="col-6 text-end"><strong>${trade.entry_price.toFixed(5)}</strong></div>
                        
                        <div class="col-6"><small>Current P/L:</small></div>
                        <div class="col-6 text-end ${profitPips >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${profitPips.toFixed(1)} pips</strong>
                        </div>
                        
                        <div class="col-6"><small>P/L %:</small></div>
                        <div class="col-6 text-end ${profitPips >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${profitPercent}%</strong>
                        </div>
                        
                        <div class="col-6"><small>Duration:</small></div>
                        <div class="col-6 text-end"><strong>${Math.round(duration)}s</strong></div>
                        
                        <div class="col-6"><small>Time Left:</small></div>
                        <div class="col-6 text-end"><strong>${timeRemaining}s</strong></div>
                        
                        <div class="col-6"><small>Status:</small></div>
                        <div class="col-6 text-end">
                            <span class="badge ${trade.status === 'OPEN' ? 'bg-warning' : 'bg-secondary'}">
                                ${trade.status || 'OPEN'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated ${
                                profitPips >= 0 ? 'bg-success' : 'bg-danger'
                            }" style="width: ${progressPercent}%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">Trade progress: ${Math.round(progressPercent)}% (${CYCLE_DURATION}s total)</small>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Target: TP at ${trade.optimal_tp.toFixed(5)} (${trade.tp_distance_pips} pips) | 
                            Max Loss: SL at ${trade.optimal_sl.toFixed(5)} (${trade.sl_distance_pips} pips)
                        </small>
                    </div>
                    
                    ${trade.data_stored_in ? `
                    <div class="small text-info mt-2">
                        <i class="bi bi-git"></i> Auto-saved to Git
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function updateTradeHistory(data) {
            const tbody = document.getElementById('tradeHistory');
            
            if (!data || !data.trades || data.trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-4">
                            <i class="bi bi-inbox display-6 d-block text-muted mb-2"></i>
                            <span class="text-muted">No trades yet</span>
                            ${data && data.data_source === 'Git Repository (Auto-Sync)' ? 
                                '<div class="small text-info mt-2"><i class="bi bi-git"></i> All trades auto-saved to Git repository</div>' : 
                                ''}
                        </td>
                    </tr>
                `;
                
                updateElementText('totalHistoryTrades', '0');
                updateElementText('totalWins', '0');
                return;
            }
            
            const totalTrades = data.total || data.trades.length;
            const profitableTrades = data.profitable || data.trades.filter(t => t.result === 'SUCCESS').length;
            
            updateElementText('totalHistoryTrades', totalTrades);
            updateElementText('totalWins', profitableTrades);
            
            let html = '';
            data.trades.slice().reverse().forEach(trade => {
                const entryTime = trade.entry_time ? new Date(trade.entry_time) : new Date();
                const exitTime = trade.exit_time ? new Date(trade.exit_time) : null;
                const duration = exitTime ? Math.round((exitTime - entryTime) / 1000) : 0;
                const profitPips = trade.profit_pips || 0;
                const confidence = trade.confidence || 0;
                const mlUsed = trade.ml_used || false;
                
                const timeStr = entryTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let resultClass = 'bg-secondary';
                let resultText = trade.result || 'PENDING';
                
                if (trade.result === 'SUCCESS') {
                    resultClass = 'bg-success';
                } else if (trade.result === 'FAILED') {
                    resultClass = 'bg-danger';
                } else if (trade.result === 'PARTIAL_SUCCESS') {
                    resultClass = 'bg-info';
                } else if (trade.result === 'PARTIAL_FAIL') {
                    resultClass = 'bg-warning';
                } else if (trade.result === 'BREAKEVEN') {
                    resultClass = 'bg-secondary';
                }
                
                html += `
                    <tr>
                        <td>
                            <strong>#${trade.id}</strong>
                            ${mlUsed ? '<br><small class="text-info"><i class="bi bi-cpu"></i> ML</small>' : ''}
                        </td>
                        <td>${timeStr}</td>
                        <td>
                            <span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                ${trade.action}
                            </span>
                        </td>
                        <td>${trade.entry_price.toFixed(5)}</td>
                        <td>
                            <small class="d-block">TP: ${trade.optimal_tp ? trade.optimal_tp.toFixed(5) : '-'}</small>
                            <small>SL: ${trade.optimal_sl ? trade.optimal_sl.toFixed(5) : '-'}</small>
                        </td>
                        <td>${trade.exit_price ? trade.exit_price.toFixed(5) : '-'}</td>
                        <td class="${profitPips >= 0 ? 'text-success' : 'text-danger'} fw-bold">
                            ${profitPips.toFixed(1)}
                        </td>
                        <td>${duration}s</td>
                        <td>
                            <span class="badge ${resultClass}">
                                ${resultText}
                            </span>
                        </td>
                        <td>
                            <div class="progress" style="height: 6px; width: 60px;">
                                <div class="progress-bar ${getConfidenceColor(confidence)}" 
                                     style="width: ${confidence}%" title="${confidence}% confidence">
                                </div>
                            </div>
                            <small>${confidence.toFixed(0)}%</small>
                        </td>
                        <td>
                            ${trade.signal_strength ? 
                                `<span class="badge ${trade.signal_strength === 3 ? 'bg-success' : trade.signal_strength === 2 ? 'bg-warning' : 'bg-secondary'}">
                                    ${trade.signal_strength}/3
                                </span>` : 
                                '-'}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateStorageStatus(data) {
            if (!data) return;
            
            const storageInfo = document.getElementById('storageInfo');
            if (storageInfo) {
                let filesHtml = '';
                if (data.files) {
                    for (const [fileName, fileInfo] of Object.entries(data.files)) {
                        if (fileInfo.exists) {
                            filesHtml += `
                                <div class="small ${fileInfo.size_bytes > 0 ? 'text-success' : 'text-muted'}">
                                    <i class="bi ${fileInfo.size_bytes > 0 ? 'bi-file-earmark-check' : 'bi-file-earmark'}"></i> 
                                    ${fileName}: ${fileInfo.size_human}
                                </div>
                            `;
                        }
                    }
                }
                
                const mlTrained = data.ml_trained || false;
                const trainingSamples = data.training_samples || 0;
                
                storageInfo.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-git display-6 ${data.git_commits > 0 ? 'text-success' : 'text-info'} mb-2"></i>
                        <h6 class="mb-2">Git Auto-Sync Storage</h6>
                        <div class="small ${data.git_commits > 0 ? 'text-success' : 'text-muted'} mb-2">
                            <i class="bi bi-hash"></i> Git Commits: ${data.git_commits || 0}
                        </div>
                        <div class="small ${data.last_commit && data.last_commit !== 'Never' ? 'text-success' : 'text-muted'} mb-2">
                            <i class="bi bi-clock"></i> Last Commit: ${data.last_commit || 'Never'}
                        </div>
                        <div class="small ${data.trade_count > 0 ? 'text-success' : 'text-muted'} mb-2">
                            <i class="bi bi-database"></i> Trade Count: ${data.trade_count || 0}
                        </div>
                        <div class="small ${mlTrained ? 'text-success' : trainingSamples > 0 ? 'text-warning' : 'text-muted'} mb-2">
                            <i class="bi bi-cpu"></i> ML Samples: ${trainingSamples} ${mlTrained ? '(Trained)' : '(Learning)'}
                        </div>
                        ${filesHtml ? `
                        <div class="mt-2 pt-2 border-top border-secondary">
                            <div class="small mb-1">Files:</div>
                            ${filesHtml}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // ==================== CHART FUNCTIONS ====================
        function updateChart(chartData) {
            try {
                const chartElement = document.getElementById('chart');
                if (!chartElement) return;
                
                if (chartInstance) {
                    Plotly.react('chart', JSON.parse(chartData).data, JSON.parse(chartData).layout);
                } else {
                    chartInstance = Plotly.newPlot('chart', JSON.parse(chartData).data, JSON.parse(chartData).layout);
                }
                
                document.getElementById('chartStatus').textContent = 'Live Chart';
                document.getElementById('chartStatus').className = 'badge bg-success me-2';
            } catch (error) {
                console.error('Error updating chart:', error);
                document.getElementById('chartStatus').textContent = 'Chart Error';
                document.getElementById('chartStatus').className = 'badge bg-danger me-2';
            }
        }

        function toggleChartFullscreen() {
            const chartDiv = document.getElementById('chart');
            if (!document.fullscreenElement) {
                chartDiv.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
                document.getElementById('toggleChart').innerHTML = '<i class="bi bi-arrows-angle-contract"></i> Exit Fullscreen';
            } else {
                document.exitFullscreen();
                document.getElementById('toggleChart').innerHTML = '<i class="bi bi-arrows-angle-expand"></i> Fullscreen';
            }
        }

        // ==================== AUTO-REFRESH SYSTEM ====================
        function startAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            refreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    fetchTradingState();
                }
            }, REFRESH_INTERVAL);
            
            if (historyTimer) {
                clearInterval(historyTimer);
            }
            
            historyTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    fetchTradeHistory();
                    fetchStorageStatus();
                    fetchMLStatus();
                }
            }, HISTORY_REFRESH_INTERVAL);
            
            if (storageTimer) {
                clearInterval(storageTimer);
            }
            
            storageTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    fetchStorageStatus();
                }
            }, 10000);
            
            updateAutoRefreshStatus(true);
            console.log('Auto-refresh started with Git sync monitoring');
        }

        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            if (historyTimer) {
                clearInterval(historyTimer);
                historyTimer = null;
            }
            
            if (storageTimer) {
                clearInterval(storageTimer);
                storageTimer = null;
            }
            
            updateAutoRefreshStatus(false);
            console.log('Auto-refresh stopped');
        }

        function toggleAutoRefresh() {
            isAutoRefreshEnabled = !isAutoRefreshEnabled;
            
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
                showToast('Auto-refresh enabled', 'info');
            } else {
                stopAutoRefresh();
                showToast('Auto-refresh disabled', 'warning');
            }
            
            const toggleBtn = document.getElementById('toggleRefresh');
            if (toggleBtn) {
                const statusSpan = toggleBtn.querySelector('span');
                if (statusSpan) {
                    statusSpan.textContent = isAutoRefreshEnabled ? 'Enabled' : 'Disabled';
                    statusSpan.className = `badge ${isAutoRefreshEnabled ? 'bg-success' : 'bg-secondary'}`;
                }
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = text;
            }
        }

        function updateProgressBar(elementId, value, colorClass = 'bg-primary') {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.width = `${Math.min(100, value)}%`;
                element.textContent = `${Math.round(value)}%`;
                element.className = `progress-bar ${colorClass}`;
                if (value > 0 && value < 100) {
                    element.classList.add('progress-bar-striped', 'progress-bar-animated');
                }
            }
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 80) return 'bg-success';
            if (confidence >= 60) return 'bg-info';
            if (confidence >= 40) return 'bg-warning';
            return 'bg-danger';
        }

        function formatTime(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        function updateSystemStatus(status, type = 'info') {
            const elements = [
                document.getElementById('systemStatus'),
                document.getElementById('systemStatusFooter')
            ];
            
            elements.forEach(element => {
                if (element) {
                    element.textContent = status;
                    element.className = `badge bg-${type}`;
                }
            });
        }

        function updateAutoRefreshStatus(enabled) {
            const elements = [
                document.getElementById('autoRefreshStatus'),
                document.getElementById('autoRefreshToggle')
            ];
            
            elements.forEach(element => {
                if (element) {
                    element.textContent = enabled ? 'Enabled' : 'Disabled';
                    element.className = `badge ${enabled ? 'bg-success' : 'bg-secondary'}`;
                }
            });
        }

        function updateFooterStatus() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="me-auto">
                            <i class="bi ${
                                type === 'success' ? 'bi-check-circle' :
                                type === 'error' ? 'bi-exclamation-circle' :
                                type === 'warning' ? 'bi-exclamation-triangle' :
                                'bi-info-circle'
                            }"></i>
                            Trading System
                        </strong>
                        <small>Just now</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body bg-dark text-white">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl, {
                delay: 3000
            });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', function () {
                toastEl.remove();
            });
        }

        // ==================== CLEANUP ====================
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Export functions for debugging
        window.fetchTradingState = fetchTradingState;
        window.fetchTradeHistory = fetchTradeHistory;
        window.fetchStorageStatus = fetchStorageStatus;
        window.fetchMLStatus = fetchMLStatus;
        window.syncWithGit = syncWithGit;
        window.resetTrading = resetTrading;
        window.startAutoRefresh = startAutoRefresh;
        window.stopAutoRefresh = stopAutoRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.showToast = showToast;

        console.log('All-in-One Trading System loaded successfully');
    </script>
</body>
</html>